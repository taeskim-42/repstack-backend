name: Auto Fix (Claude Code)

on:
  issues:
    types: [labeled]

jobs:
  auto-fix:
    # Only trigger when 'auto-fix' label is added
    if: github.event.label.name == 'auto-fix'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: repstack_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Set up database
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load
        env:
          RAILS_ENV: test
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/repstack_test

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: ""
          label_trigger: "auto-fix"
          prompt: |
            Fix the TestFlight bug described in this issue. The issue contains AI analysis with root cause and suggested fix.

            IMPORTANT: Be efficient. Skip reading CLAUDE.md or unrelated files. Go directly to the affected files.

            1. Read the issue to understand the bug and suggested fix
            2. Find and fix the affected files with minimal changes
            3. Do NOT modify: db/migrate/, config/credentials*, Gemfile
            4. Do NOT add new gems
            5. Commit referencing issue #${{ github.event.issue.number }}
          claude_args: "--max-turns 50"
          track_progress: true

      - name: Safety check - block dangerous changes
        if: always()
        run: |
          DANGEROUS_FILES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E '^(db/migrate/|config/|Gemfile)' || true)
          if [ -n "$DANGEROUS_FILES" ]; then
            echo "::error::Dangerous files modified by auto-fix: $DANGEROUS_FILES"
            gh issue comment ${{ github.event.issue.number }} \
              --body "Auto-fix modified restricted files: \`$DANGEROUS_FILES\`. Manual review required."
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
