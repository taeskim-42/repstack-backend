name: Auto Fix (Claude Code)

on:
  issues:
    types: [labeled]

jobs:
  auto-fix:
    # Only trigger when 'auto-fix' label is added
    if: github.event.label.name == 'auto-fix'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: repstack_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Set up database
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load
        env:
          RAILS_ENV: test
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/repstack_test

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: ""
          label_trigger: "auto-fix"
          prompt: |
            You are fixing a bug reported from TestFlight feedback.
            Read the issue carefully - it contains AI analysis with root cause hypothesis and suggested fixes.

            Environment:
            - Ruby on Rails backend, Ruby 3.3
            - PostgreSQL test DB at: postgres://postgres:postgres@localhost:5432/repstack_test
            - Redis at: localhost:6379
            - RAILS_ENV=test

            Steps:
            1. Read and understand the issue (bug description, root cause, suggested fix)
            2. Find the relevant source files
            3. Fix the bug with minimal changes
            4. Run tests: RAILS_ENV=test DATABASE_URL=postgres://postgres:postgres@localhost:5432/repstack_test bundle exec rspec
            5. If tests pass, create a PR with title starting with "[TestFlight Auto-Fix]"
            6. If the fix requires a migration or config change, comment on the issue explaining why and stop

            Rules:
            - Fix the bug with minimal changes
            - Do NOT modify: db/migrate/, config/credentials*, Gemfile
            - Do NOT add new gems
            - Commit message should reference issue #${{ github.event.issue.number }}
          additional_permissions: "Bash(bundle exec:*),Bash(RAILS_ENV=test:*),Bash(DATABASE_URL=*:*),Bash(ls:*),Bash(cat:*),Bash(ruby:*)"
          claude_args: "--max-turns 25"
          track_progress: true

      - name: Safety check - block dangerous changes
        if: always()
        run: |
          DANGEROUS_FILES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E '^(db/migrate/|config/|Gemfile)' || true)
          if [ -n "$DANGEROUS_FILES" ]; then
            echo "::error::Dangerous files modified by auto-fix: $DANGEROUS_FILES"
            gh issue comment ${{ github.event.issue.number }} \
              --body "Auto-fix modified restricted files: \`$DANGEROUS_FILES\`. Manual review required."
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
